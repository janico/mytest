<?xml version="1.0" encoding="UTF-8"?>
<project name="mytest" default="ci" basedir="../../..">
    <property name="source" value="workspace" />
 
    <target name="ci"
            description="Tâche principale d'intégration continue"
            depends="clean,qa"/>
 
    <target name="clean" description="Vide les répertoires d'artefacts">
        <delete dir="${project.basedir}/workspace/build/api" />
        <delete dir="${project.basedir}/workspace/build/code-browser" />
        <delete dir="${project.basedir}/workspace/build/coverage" />
        <delete dir="${project.basedir}/workspace/build/logs" />
        <delete dir="${project.basedir}/workspace/build/pdepend" />
        <delete dir="${project.basedir}/workspace/build/package" />
        <delete dir="${project.basedir}/workspace/build/test" />
	 
        <mkdir dir="${project.basedir}/workspace/build/api" />
        <mkdir dir="${project.basedir}/workspace/build/code-browser" />
        <mkdir dir="${project.basedir}/workspace/build/coverage" />
        <mkdir dir="${project.basedir}/workspace/build/logs" />
        <mkdir dir="${project.basedir}/workspace/build/pdepend" />
        <mkdir dir="${project.basedir}/workspace/build/package" />
        <mkdir dir="${project.basedir}/workspace/build/test" />
    </target>
 
    <target name="qa" description="Lance les outils d'analyse">
        <phingcall target="package" />
    </target>

    
	 <target name="package">
        <tar destfile="${project.basedir}/workspace/build/package/mytest.tar.gz" compression="gzip" 
                     excludes=".git/**" basedir="${project.basedir}/workspace/"/>
        <copy file="${project.basedir}/workspace/build/package/mytest.tar.gz" todir="/var/www/mytest/livraison/"/>
    </target>
	
	<target name="deploy-mytest"> <!-- mytest -->
		<echo msg="sudo chown -R hudson:nogroup /var/www/mytest/" />
		<exec command="sudo chown -R hudson:nogroup /var/www/mytest/" logoutput="true" />
		
		<echo msg="chmod -R 775 /var/www/mytest/" />
		<exec command="chmod -R 775 /var/www/mytest/" logoutput="true" />
		
		<untar  file="/var/www/mytest/livraison/mytest.tar.gz" todir="/var/www/mytest/" />
		<!--
		<echo msg="rm -Rf /var/www/mytest/app/cache/*" />
		<exec command="rm -Rf /var/www/mytest/app/cache/*" logoutput="true" />
		
		<echo msg="php /var/www/mytest/app/console doctrine:schema:update --force" />
		<exec command="php /var/www/mytest/app/console doctrine:schema:update --force" />
	
		<echo msg="php /var/www/mytest/app/console assets:install web" />
		<exec command="php /var/www/mytest/app/console assets:install web" />
			
		<echo msg="chmod -R 775 /var/www/mytest/app/cache/dev" />
		<exec command="chmod -R 775 /var/www/mytest/app/cache/dev" logoutput="true" />
		
		<echo msg="find /var/www/mytest/ -name '.svn' -type d -exec rm -rf {} \;" />
		<exec command="find /var/www/mytest/ -name '.svn' -type d -exec rm -rf {} \;" logoutput="true" />
		
		<echo msg="sudo chown -R www-data:www-data /var/www/mytest/" />
		<exec command="sudo chown -R www-data:www-data /var/www/mytest/" logoutput="true" />
		-->
		
    </target>

</project>